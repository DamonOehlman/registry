var IoC=function(){function c(a){var b=this;a=a||"",this._ns="ioc."+(a?a+".":""),this._definitions={},this._instances={},eve.on(this._ns+"get",function(){return b._create.apply(b,Array.prototype.slice.call(arguments))})}var a=/^(.*)\[(.*)\]$/,b=/^(\+)?(\w+)\=?(.*)$/;return c.prototype._create=function(a,b,c){var d=this,e=eve.nt().slice((this._ns+"get.").length),f=Array.prototype.slice.call(arguments),g=[];return _.each(this._find(this._definitions,e,b),function(a){var b=d._instances[a.type],e;b||(b=d._instances[a.type]=[]),e=a&&a.creator&&(a.singleton&&b.length===0||c),e&&(typeof a.creator=="function"?newInstance=a.creator.apply(null,f):typeof a.creator.constructor=="function"&&(newInstance=new a.creator.constructor),newInstance&&(eve(this._ns+"create."+a.type,this,newInstance),b[b.length]=newInstance)),g=g.concat(b)}),g},c.prototype._extractAttributes=function(c,d,e){a.test(c)&&(c=RegExp.$1,_.each(RegExp.$2.split(/[\,\s]\s*/),function(a){var c=b.exec(a);c&&(e[c[2]]=parseFloat(c[3])||c[3]||!0)}));if(d&&d.constructor)for(var f in d)typeof d[f]!="function"&&(e[f]=d[f]);return c},c.prototype._find=function(a,b,c){var d=new RegExp("^"+(b||"").replace(/\.\*?$/,"")+"(?:$|\\.)"),e,f=[];for(e in a)d.test(e)&&(f[f.length]=a[e]);return a===this._definitions&&c&&(f=_.filter(f,function(a){return!0})),f},c.prototype.accept=function(a,b,c){var d,e,f=[];typeof b=="function"&&(c=b,b={}),b=b||{};if(!c)return{};d=this._ns+(b.definition?"define.":"create.")+a,e=typeof b.existing=="undefined"||b.existing,e&&b.definition?f=this._find(this._definitions,a):e&&(f=_.flatten(this._find(this._instances,a)));for(var g=0,h=f.length;g<h;g++)c(f[g]);return eve.on(d,c),{stop:function(){eve.unbind(d,c)}}},c.prototype.define=function(a,b,c){var d=this,e,f={};return arguments.length<=2&&(c=b,b={}),b=b||{},a=this._extractAttributes(a,c,f),e=this._definitions[a]={type:a,attributes:f,singleton:b.singleton,creator:c,getInstance:function(){return d.getInstance(a)}},eve(this._ns+"define."+a,e),e},c.prototype.getInstance=function(a,b){return this.instances(a,b,!0)[0]},c.prototype.instances=function(a,b,c){return _.flatten(eve.apply(eve,[this._ns+"get."+a,this].concat(Array.prototype.slice.call(arguments))))},c.prototype.singleton=function(a,b,c){arguments.length<=2&&(c=b,b={}),b=b||{},b.singleton=!0,this.define(a,b,c)},new c}()