(function(a){function d(a){var b=this;a=a||"",this._ns="ioc."+(a?a+".":""),this._definitions={},this._instances={},eve.on(this._ns+"get",function(){return b._create.apply(b,Array.prototype.slice.call(arguments))})}var b=/^(.*)\[(.*)\]$/,c=/^(\+)?(\w+)\=?(.*)$/;d.prototype._create=function(a,b,c){var d=this,e=eve.nt().slice((this._ns+"get.").length),f=Array.prototype.slice.call(arguments),g=[],h;return _.each(this._find(this._definitions,e,b),function(a){var b=d._instances[a.type],e;b||(b=d._instances[a.type]=[]),e=a&&a.creator&&(a.singleton&&b.length===0||c),e&&(typeof a.creator=="function"?h=a.creator.apply(null):a.creator&&a.creator.prototype&&typeof a.creator.constructor=="function"?h=new a.creator.constructor:a.singleton&&a.creator&&(h=a.creator),h&&(eve(this._ns+"create."+a.type,this,h),b[b.length]=h)),g=g.concat(b)}),g},d.prototype._extractAttributes=function(a,d,e){b.test(a)&&(a=RegExp.$1,_.each(RegExp.$2.split(/[\,\s]\s*/),function(a){var b=c.exec(a);b&&(e[b[2]]=parseFloat(b[3])||b[3]||!0)}));if(d&&d.constructor)for(var f in d)typeof d[f]!="function"&&(e[f]=d[f]);return a},d.prototype._find=function(a,b,c){var d=new RegExp("^"+(b||"").replace(/\.\*?$/,"")+"(?:$|\\.)"),e,f=[];for(e in a)d.test(e)&&(f[f.length]=a[e]);if(a===this._definitions&&c){var g=matchme();f=_.filter(f,function(a){return g.target=a.attributes,g.query(c).ok})}return f},d.prototype.accept=function(a,b,c){var d,e,f=[];typeof b=="function"&&(c=b,b={}),b=b||{};if(!c)return{};d=this._ns+(b.definition?"define.":"create.")+a,e=typeof b.existing=="undefined"||b.existing,e&&b.definition?f=this._find(this._definitions,a):e&&(f=_.flatten(this._find(this._instances,a)));for(var g=0,h=f.length;g<h;g++)c(f[g]);return eve.on(d,c),{stop:function(){eve.unbind(d,c)}}},d.prototype.define=function(a,b,c){var d=this,e,f={};arguments.length<=2&&(c=b,b={}),b=b||{},a=this._extractAttributes(a,c,f);if(!c)throw new Error("Unable to define an instance with no creator");var g=typeof c=="object",h=c&&c.prototype&&typeof c.constructor=="function";return g&&!h&&(b.singleton=!0),e=this._definitions[a]={type:a,attributes:f,singleton:b.singleton,creator:c,getInstance:function(){return d.getInstance(a)}},eve(this._ns+"define."+a,e),e},d.prototype.getInstance=function(a,b){return this.instances(a,b,!0)[0]},d.prototype.instances=function(a,b,c){return _.flatten(eve.apply(eve,[this._ns+"get."+a,this].concat(Array.prototype.slice.call(arguments))))},d.prototype.singleton=function(a,b,c){arguments.length<=2&&(c=b,b={}),b=b||{},b.singleton=!0,this.define(a,b,c)};var e=new d;typeof module!="undefined"&&module.exports?module.exports=e:typeof define!="undefined"?define("IoC",[],function(){return e}):a.IoC=e})(this)